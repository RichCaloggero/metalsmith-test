<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Login</title>
</head>
<body>
<nav>
<a href="/">Home</a>
<button class="user-info">User info</button>
<button class="logout">Logout</button>
</nav>
<main>
<div role="status" id="status"></div>

<div class="page" id="login">
<h1 class="page-title">Login</h1>
<form>
<label>eMail: <input required type="email" autofocus class="e-mail"></label>
<label>Password: <input required type="password" class="password"></label>
<button class="login">login</button>
</form>
</div><!-- login page -->

<div class="page" id="edit-file" hidden>
<h1 class="page-title">Edit File</h1>
<label>File to edit:
<br><select class="file-list"></select>
</label>
<hr>
<textarea class="file-contents" rows="30" cols="80"></textarea>
<hr>
<button class="update">Update</button>

</div><!-- edit file page -->

<div class="page" id="user-info" hidden>
<h1 class="page-title">User Info</h1>
<form>
<label>First name: <input type="text" class="first-name"></label>
<label>Last name: <input type="text" class="last-name"></label>
<br><label>eMail: <input required type="email" class="e-mail"></label>
<br><label>Password: <input required type="password" class="password"></label>
<label>Confirm password: <input required type="password" class="password-confirmation"></label>
<br><br><button class="submit">Update</button>
</form>
</div><!-- user-info page -->

</main>

<script src="/socket.io/socket.io.js"></script>
<script type="module">
import {$, $$, not, statusMessage} from "./utilities.js";
import {registerDomEvents} from "./eventRegistration.js";
import {registerSocketEvents} from "./socketEvents.js";


const socket = io({
rememberUpgrade: true,
});
statusMessage("Ready.");
let userInfo = null;

registerDomEvents({
"nav .user-info": {handler: displayUserInfo},
"nav .logout": {handler: logout},
"#login .login": {handler: requestLogin},
"#edit-file .file-list": {type: "change", handler: requestFile},
"#edit-file .update": {handler: requestFileUpdate},
"#user-info .submit": {handler: requestUpdateUserInfo},
});

registerSocketEvents(socket, {
fileList: displayFileList,
fileContents: displayFileContents,
fileUpdateComplete,
loginComplete, loginFailed, userInfoUpdateComplete, userInfoUpdateFailed
});


socket.onAny(data => console.log("log: received event ", data));
document.addEventListener("submit", e => e.preventDefault());

/// dom event handlers

function requestUpdateUserInfo () {
const newInfo = getUserInfo();
if (not(newInfo)) {
statusMessage("Passwords do not match; please try again.");
setTimeout(() => $("#user-info .password").focus(), 2000);
return;
} // if

if (userInfo) {
console.log("updating logged in user with ", newInfo);

if (not(newInfo.eMail === userInfo.eMail)) {
console.log("eMails do not match");
statusMessage("eMail is incorrect; please try again.");
$("#user-info .e-mail").focus();
return;
} // if

socket.emit("requestUpdateUserInfo", newInfo);
return;
} // if

console.log("adding new user: ", newInfo);
socket.emit("requestAddUser", newInfo);
} // updateUserInfo

function getUserInfo () {
const info = $("#user-info");
const eMail = $(".e-mail", info).value, firstName = $(".first-name", info).value, lastName = $(".last-name", info).value, password1 = $(".password", info).value, password2 = $(".password-confirmation", info).value;
return (password1 === password2)? 
{eMail, firstName, lastName, password: password1}
: null;
} // getUserInfo

function userInfoUpdateComplete (socket, data) {
statusMessage("Changes saved.");
showContent($("#login"));
$("#login .e-mail").focus();
} // userInfoUpdateComplete

function userInfoUpdateFailed (socket, data) {
statusMessage("Update failed.");
} // userInfoUpdateFailed

function addUserComplete (socket, data) {
statusMessage("New user added.");
showContent($("#login"));
$("#login .e-mail").focus();
} // addUserComplete

function addUserFailed (socket, data) {
statusMessage("Update failed.");
} // addUserFailed


function requestLogin () {
if ($("#login form").checkValidity()) socket.emit("requestLogin", {eMail: $("#login .e-mail").value, password: $("#login .password").value});
} // requestLogin

function requestFile () {
const name = $("#edit-file .file-list").value;
console.log(`requesting file ${name}`);
socket.emit("requestFile", {name});
} // requestFile

function requestFileUpdate (e) {
const name = $("#edit-file .file-list").value;
const contents = $("#edit-file .file-contents").value;

socket.emit("requestFileUpdate", {name, contents});
} // requestFileUpdate

function fileUpdateComplete (socket, data) {
statusMessage(`${data.name}: update complete.`);
} // fileUpdateComplete

function requestUserInfo () {
socket.emit("requestUserInfo");
} // requestUserInfo

/// socket event handlers

function loginComplete (socket, data) {
userInfo = data;
socket.emit("requestFileList");
console.log("userInfo: ", userInfo);
} // loginComplete


function logout () {
window.removeEventListener("beforeunload", unloadHandler);
window.location = window.location;
} // logout

function displayUserInfo () {
if (userInfo) populateUserInfo(userInfo);
showContent ($("#user-info"));
$("#user-info .first-name").focus();
} // displayUserInfo

function populateUserInfo (data) {
$("#user-info .e-mail").value = data.eMail;
$("#user-info .first-name").value = data.firstName;
$("#user-info .last-name").value = data.lastName;
} // populateUserInfo

function displayFileList (socket, data) {
console.log("fileList: ", data);
data.forEach(item => {
const option = document.createElement("option");
option.textContent = item;
$(".file-list").appendChild(option);
}); // forEach

showContent($("#edit-file"));
$(".file-list").dispatchEvent(new CustomEvent("change", {bubbles: true}));
$(".file-list").focus();
window.addEventListener("beforeunload", unloadHandler);
} // displayFileList

function unloadHandler (e) {
(e || window.event).returnValue = "Oh please don't go!";
return "Oh please don't go!";
} // unloadHandler

function loginFailed () {
statusMessage("Invalid credentials; please try again.");
} // loginFailed



function displayFileContents (socket, data) {
console.log("displayFileContents: ", data);
$(".file-contents").textContent = data.contents;
} // displayFileContents


function registerUser (socket, data) {
socket.emit("registerUser", userInfo);
} // registerUser



function showContent (container) {
const title = $(".page-title", container).textContent;
$$("main > .page").forEach(page => page.hidden = not(page === container));
$("title").textContent = title;
$(".page-title", container).tabIndex = -1;
$(".page-title", container).focus();
} // showContent


</script>

</body>
</html>

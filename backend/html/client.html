<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Login</title>
</head>
<body>
<main>
<div role="status" id="status"></div>

<div class="page" id="login">
<h1 class="page-title">Login</h1>
<div role="form" class="login">
<label>eMail: <input type="text" class="eMail"></label>
<label>Password: <input type="password" class="password"></label>
<button class="login">login</button>
</div>
</div><!-- login page -->

<div class="page" id="edit-file" hidden>
<h1 class="page-title">Edit File</h1>
<label>File to edit:
<br><select class="file-list"></select>
</label>
<hr>
<textarea class="file-contents" rows="30" cols="80"></textarea>
<hr>
<button class="update">Update</button>

</div><!-- edit file page -->

</main>

<script src="/socket.io/socket.io.js"></script>
<script>
{ // global scope
const socket = io();
statusMessage("Ready.");

$(".login").addEventListener("click", login);
socket.on("loginFailed", loginFailed);
socket.on("fileList", displayFileList);

$(".file-list").addEventListener("change", e => requestFile(e.target.value));
socket.on("fileContents", displayFileContents);
$(".update").addEventListener("click", () => updateFile($(".file-list").value, $(".file-contents").value));
socket.on("updateSuccessful", updateSuccessful);


socket.on("connect", () => {
console.log("connected...");
});

socket.on("disconnect", () => {
console.log("disconnected.");
});

/// event handlers

function login () {
socket.emit("login", {eMail: $(".eMail").value, password: $(".password").value});
} // login

function displayFileList (data) {
data.fileList.forEach(item => {
option = document.createElement("option");
option.textContent = item;
$(".file-list").appendChild(option);
}); // forEach

showContent($("#edit-file"));
$(".file-list").focus();
} // displayFileList

function loginFailed () {
statusMessage("Invalid credentials; please try again.");
} // loginFailed

function requestFile (name) {
console.log(`requesting file ${name}`);
socket.emit("requestFile", {name});
} // requestFile

function updateFile (name, contents) {
socket.emit("updateFile", {name: name, contents: contents});
} // updateFile

function updateSuccessful () {
statusMessage("Update successful.");
} // updateSuccessful

function displayFileContents (data) {
$(".file-contents").textContent = data.contents;
} // displayFileContents

function showContent (container) {
const title = $(".page-title", container).textContent;
$$("main > .page").forEach(page => page.hidden = not(page === container));
$("title").textContent = title;
$(".page-title", container).tabIndex = -1;
$(".page-title", container).focus();
} // showContent

function statusMessage (text) {$("#status").textContent = text; setTimeout(() => $("#status").textContent = "", 10000);}
function $ (s, c = document) {return c.querySelector(s);}
function $$ (s, c = document) {return [...c.querySelectorAll(s)];}
function not (x) {return !Boolean(x);}
} // global scope
</script>

</body>
</html>
